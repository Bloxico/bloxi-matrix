system: Chain
subsystem: Drand Beacon
features:
  - name: New Drand beacon
    behaviors:
      - id: BLOCKCHAIN_BEACON_DRAND_NEW_DRAND_BEACON_01
        description: |
          Given a genesis ticket, interval, optional pubsub, and drand config,
          return a new DRAND Beacon with the specified fields set
  
  - name: Get entry
    behaviors: 
      - id: BLOCKCHAIN_BEACON_DRAND_GET_ENTRY_01
        description: |
          Given a Drand beacon, a context, and a chain round,
          return a channel which returns a beacon entry (ie. random data)

  - name: Cache value
    behaviors:
      - id: BLOCKCHAIN_BEACON_DRAND_CACHE_VALUE_01
        description: |
          Given a Drand beacon, and a beacon entry,
          cache the entry in the beacon's cache for the entry's round
  
  - name: Get Cached value
    behaviors:
      - id: BLOCKCHAIN_BEACON_DRAND_GET_CACHED_VALUE_01
        description: |
          Given a round, and cached entry exists in the beacon for that round,
          return the cached entry
      - id: BLOCKCHAIN_BEACON_DRAND_GET_CACHED_VALUE_02
        description: |
          Given a round, and cached entry does not exist in the beacon's cache,
          return nothing

  - name: Verify entry
    behaviors:
      - id: BLOCKCHAIN_BEACON_DRAND_VERIFY_ENTRY_01
        description: |
          Given a current round beacon entry 'curr', and a previous round beacon
          entry 'prev', verify that 'curr' is a valid beacon entry and return noting (no error)
      - id: BLOCKCHAIN_BEACON_DRAND_VERIFY_ENTRY_02
        description: |
          Given that 'curr' round is not equal to 'prev' round + 1, return error
      - id: BLOCKCHAIN_BEACON_DRAND_VERIFY_ENTRY_03
        description: |
          Given that cached entry exists for 'curr' round, and that 'curr'
          data is not equal to the cached value, return error
      - id: BLOCKCHAIN_BEACON_DRAND_VERIFY_ENTRY_04
        description: |
          Given that the Drand beacon constructed using 'prev' entry, and 'curr'
          round and signature is invalid (ie. the beacon does not verify the pubkey),
          return error
          
  - name: Get max beacon round for epoch
    behaviors:
      - id: BLOCKCHAIN_BEACON_DRAND_GET_MAX_BEACON_ROUND_FOR_EPOCH_01
        description: |
          Given a Drand beacon 'db', and a chain epoch 'epoch', return max beacon
          round time for the epoch, given by the formula:
          `t = ((epoch * db.filRoundTime) + db.filGenTime) - db.filRoundTime`
          `maxRound = (t - db.drandGenTime) / db.interval.Seconds`